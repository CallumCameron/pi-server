#!/bin/bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

function usage()
{
    echo "Usage: $(basename "${0}") new_ca_dir"
    echo "    new_ca_dir must not already exist, and should probably be somewhere encrypted!"
    exit 1
}

test -z "${1}" && usage
test -e "${1}" && usage

CA_DIR="${1}"

mkdir -p "${CA_DIR}" &&
mkdir -p "${CA_DIR}/ca" &&
mkdir -p "${CA_DIR}/data" &&
cp -a "${DIR}/scripts" "${CA_DIR}/scripts" &&
cp "${DIR}/openssl.conf" "${CA_DIR}/openssl.conf" &&
touch "${CA_DIR}/data/index.txt" &&
echo 0 > "${CA_DIR}/data/serial.txt" &&

export CA_DIR &&
openssl req -config "${CA_DIR}/openssl.conf" -x509 -newkey rsa -keyout "${CA_DIR}/ca/ca.key" -out "${CA_DIR}/ca/ca.crt" -outform PEM &&
chmod u=r "${CA_DIR}/ca/ca.crt" "${CA_DIR}/ca/ca.key" &&
chmod go-rwx "${CA_DIR}/ca/ca.key" &&
chmod go=r "${CA_DIR}/ca/ca.crt"

# openssl ca -config "${CA_DIR}/openssl.conf" -gencrl
