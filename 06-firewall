#!/bin/bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Port knocker
KNOCKD="${DIR}/knockd"
KNOCKD_TARGET='/etc/default/knockd'
KNOCKD_CONF="${DIR}/knockd.conf"
KNOCKD_CONF_TARGET='/etc/knockd.conf'

SSH_PORT="$(grep '^Port' /etc/ssh/sshd_config | awk '{print $2}')" &&

printf "Enter port-knocking sequence for ssh; this should be a list of comma-separated ports (optionally postfixed with :tcp or :udp (TCP is the default)), with NO SPACES!: " &&
read SEQUENCE &&

printf "Enter interface for port knocker; usually eth0: " &&
read IFACE &&

printf "Enter port for HTTPS (usually 443): " &&
read HTTPS_PORT &&

TMPFILE="$(mktemp)" &&
cp "${KNOCKD_CONF}" "${TMPFILE}" &&
sed -i "s/@@@@@1@@@@@/${SEQUENCE}/g" "${TMPFILE}" &&
sed -i "s/@@@@@2@@@@@/${SSH_PORT}/g" "${TMPFILE}" &&
sudo cp "${TMPFILE}" "${KNOCKD_CONF_TARGET}" &&
sudo chown root:root "${KNOCKD_CONF_TARGET}" &&
sudo chmod a=r "${KNOCKD_CONF_TARGET}" &&
sudo chmod go-rwx "${KNOCKD_CONF_TARGET}" &&
rm "${TMPFILE}" &&

TMPFILE="$(mktemp)" &&
cp "${KNOCKD}" "${TMPFILE}" &&
sed -i "s/@@@@@1@@@@@/${IFACE}/g" "${TMPFILE}" &&
sudo cp "${TMPFILE}" "${KNOCKD_TARGET}" &&
sudo chown root:root "${KNOCKD_TARGET}" &&
sudo chmod a=r "${KNOCKD_TARGET}" &&
sudo chmod go-rwx "${KNOCKD_TARGET}" &&
rm "${TMPFILE}" &&

# IPtables
RULES="${DIR}/iptables.rules" &&
RULES_TARGET='/etc/iptables.rules' &&
SCRIPT="${DIR}/iptables" &&
SCRIPT_TARGET='/etc/network/if-pre-up.d/iptables' &&

TMPFILE="$(mktemp)" &&
cp "${RULES}" "${TMPFILE}" &&
sed -i "s/@@@@@1@@@@@/${HTTPS_PORT}/g" "${TMPFILE}" &&
sudo cp "${TMPFILE}" "${RULES_TARGET}" &&
sudo chown root:root "${RULES_TARGET}" &&
sudo chmod u=r "${RULES_TARGET}" &&
sudo chmod go-rwx "${RULES_TARGET}" &&
rm "${TMPFILE}" &&

sudo cp "${SCRIPT}" "${SCRIPT_TARGET}" &&
sudo chown root:root "${SCRIPT_TARGET}" &&
sudo chmod u=rx "${SCRIPT_TARGET}" &&
sudo chmod go-rwx "${SCRIPT_TARGET}"
